---
layout: post
title: "Блок управления внешней нагрузкой контроллера для гидропоники"
date: 2015-08-09 09:57:15 +0300
comments: true
categories: 
- STM32F031F
- гидропоника
- контроллер
- LM2842
- LM1117
- HCPL053X
- IRF7341
---

Блок является частью [контроллера](/blog/2015/07/25/controller-for-hydroponics) для гидропоники и выполняет управление четырьмя массивами светодиодов.

{% img /images/2015-08-09-load-control-block-of-controller-for-hydroponics/LedPower.png %}


### Step-down преобразователь +30В -> +15В

Преобразователь выполнен на базе **LM2842** (U1). Параметры преобразователя и порядок его настройки приводится в описании [основного блока](blog/2015/08/02/main-block-of-controller-for-hydroponics/).

**Расчёт:**

1) Входные данные: VIN = 30 В, VOUT = 15 В, IOUT = 0,5 А, Iripple = 0,15 А.

2) R1 = 1,5 кОм, R2 = (VOUT/0,765 – 1) * R1 = (15 / 0,765 – 1) * 1,5 = 28 кОм.

3) СIN = 10 мкФ (керамика).

4) L1 = (30 – 15) * 15 / (30 * 0,15 * 550 * 10<sup>3</sup>) = 91 мкГн (SDR1006-101KL).

5) COUT = 22 мкФ, Vripple=0,15 * (0,35 + [1 / (8 * 550 * 10<sup>3</sup> * 22 * 10<sup>-6</sup>)] = 0,053 В.

6) CBOOT = 1,0 мкФ.

7) D1 – 10BQ060 (60 В, 1,0 А).

### Преобразователь +15В -> +3,3В

Преобразователь построен на базе микросхемы **LM1117**-N-3 (U2), характеризуемой максимальным током 800 мА.

**Расчёт:**

1) Входной конденсатор – 10 мкФ (тантал).

2) Выходной конденсатор – от 10 мкФ, рекомендуется 22 мкФ (тантал, ESR от 0,3 до 22 Ом).

### Измерение тока в цепи нагрузки

Последовательно с нагрузкой соединён резистор номиналом 1 Ом (R29 - R32). Падение напряжения на этом резисторе пропорционально току, протекающему в цепи нагрузки. Это падение напряжения измеряется микроконтроллером **STM32F031F** (U3). Измеренное падение напряжения преобразуется микроконтроллером в периодический импульсный сигнал, имеющий фиксированную частоту 50 Гц и изменяемый коэффициент заполнения импульсов, пропорциональный падению напряжения. Этот периодический сигнал (F1-F4) поступает через транзистор (Q3-Q6) на оптопару HCPL053X (U10, U11) и далее в основной блок контроллера.

Прямой ток через диод оптопары HCPL053X составляет IF = (3,3 – VF)/R = (3,3 – 1,45) / 100 = 18,5 мА

Максимальный выходной ток оптопары при IF = 18,5 мА составляет примерно IO = 6 мА.

Для управления оптопарой выбран транзистор BC807 (коэффициент усиления по току – 100, не менее; в базе резистор 4,7 кОм, то есть базовый ток составляет (3,3 – 0,7)/4,7 = 0,55 мА, что позволяет получить ток коллектора от 50 мА и выше).

### Управление нагрузкой

Управляющие сигналы на открытие силовых ключей поступают из основного блока контроллера на оптопары **HCPL053X** (U4, U7). Напряжение питания оптопар составляет +15 В.

Сигнал с коллектора оптопары поступает на инверсный вход драйвера n-канального MOSFET-транзистора (U5, U6 и U8, U9). В качестве драйвера используется микросхема IR2128S (с возможностью контроля КЗ; данная функция не используется). Драйвер также как и оптопара запитан от источника +15 В.

Сигнал с драйвера через резистор номиналом 100 Ом поступает на затвор силового n-канального транзистора IRF7341 (Q1, Q2). Силовой транзистор коммутирует напряжение +30 В на LC-фильтр нагрузки.

### Расчёт LC-фильтра нагрузки

Расчёт происходит двумя способами, которые дают схожие результаты:

* способом, использованном для расчёта преобразователя +30В -> +15В;
* способом, описанном в статье "*Катушки индуктивности Bourns для преобразователей энергии*".

Начальные данные: fsw = 10 кГц, VIN = 30 В, IOUT = 1 А. Выходное напряжение изменяется в диапазоне от 0 до 30 В.

Из статьи "*Катушки индуктивности Bourns для преобразователей энергии*":

1) Период импульсов: Tsw = 1 / fsw = 100 мкс.

2) **Средний** коэффициент заполнения: D = (VOUTmax – VOUTmin) / 2VIN = (30 – 0) / (2 * 30) = 0,5.

3) Время открытия ключа Ton = DTsw = 50 мкс.

4) Величина пульсаций тока: Iripple = 0,3 * IOUT = 0,3 А.

*Примечания*
 
1 Величина пульсаций (и это важно) означает разницу между значением тока, протекающим через катушку в момент закрытия ключа, и значением тока, протекающим через катушку в момент открытия ключа. Другими словами, в момент открытия ключа ток, имеющий значение I1, начинает линейно расти до значения I1 + Iripple. В момент закрытия ключа ток начинает линейно уменьшаться (происходит заряд конденсатора COUT) до значения I1. С новым импульсом на открытие ключа цикл повторяется.

2 Из величины Iripple следует, что значение минимального стационарного тока составляет Is = Iripple/2 = 150 мА. Минимальный стационарный ток – это ток, который может быть передан дросселем в ёмкость COUT после закрытия ключа при заданном коэффициенте заполнения импульсов коммутации ключа. Если нагрузка требует меньший ток, то появятся автоколебания тока после закрытия ключа (ток потечёт в обратную сторону – в дроссель). Чтобы это исключить после дросселя устанавливается диод Шоттки.

5) Падение напряжения на катушке: V = VIN – (VOUTmax - VOUTmin) / 2 – Vdiode = 30 – 15 – 1 = 14 В.

6) Минимальное значение индуктивности: L2 = L3= L4 = L5 = VTon / Iripple = 2,333 мГн

7) COUT = C12 = C15 = C19 = C22 = 150 мкФ, ESR = 0,3 (танталовый). Пульсации напряжения для выбранного конденсатора составят: Vripple = Iripple(ESR + [1 / (8 * fsw * COUT)]) = 0,115 В.

Расчёт дросселя выполнялся в программе DrosselRing (1100):

{% img /images/2015-08-09-load-control-block-of-controller-for-hydroponics/LedL.png %}